---
layout: default
title: SMA
parent: Telescopes Tips
grand_parent: To my students
nav_order: 1
---

### If this is your first time

If you are my postdoc, and if you need me to revise English or double check the technical setup, forward me your first draft at least **2 weeks** ahead of the proposal deadline.
{: .fs-1 }

If you are my student, forward me your first draft at least **4 weeks** ahead of the proposal deadline. I will spend time iterating with you many times for education purposes.
{: .fs-1 }

### Proposing

#### Timeline and interface

**There are two proposal deadlines each year. They are normally in mid-March and mid-September but please pay attention to the call for proposals.**
{: .fs-2 }

Please register an **account** at the [SMA Observer Center](http://sma1.sma.hawaii.edu/) well ahead of the proposal deadline (e.g., one month ahead or earlier). You need to log in and familiarize yourself with how to prepare for the cover-page online.
{: .fs-2 }

Usually, you try to form a rough idea about what you are going to propose (target source(s), resolution, spectral setup, and sensitivity). Let's say, this is at least 1~1.5 months ahead of the proposal deadline. If you are my student and postdoc, please come discuss with me about this rough idea.
{: .fs-2 }

#### Preparation-1: Feasibility, complementary data, and duplication

**After we agree that this idea is worth pursuing and is technically feasible
, you should use the [SMA Data Archive](https://lweb.cfa.harvard.edu/cgi-bin/sma/smaarch.pl) to check whether or not you are duplicating historical or ongoing projects.** In the case that you are duplicating, you can (1) give up and try to come up with other proposal ideas, or (2) download the archival data can see if the calibrated data can achieve the quality that is needed for your science purpose. If the quality of the archival data is fair, then just continue to use that data to proceed with your research. If there is no archival data or if the quality of the archival data is poor, you can go ahead to complete the preparation of your proposal. **You need to explicitly and convincingly explain what was the problem with the archival data if it exists. So prepare your proposal well ahead of the deadline** in case you really need to look into some archival data or need other colleagues to check the archival for you. Close to the deadline, they (and I) have to prepare their own proposals thus may refuse to help you.
{: .fs-2 }

**Do not waster your (and my) time to prepare a proposal that has a problem with unnecessary duplication. Such proposals will be rejected for 100% sure.**
{: .fs-2 }

When making the duplication checks mentioned above, you may find that there are other observations on your target source(s) which can help your science case to some extent although they do not fully resolve the problem. For example, you may find that some short-spacing observations for your high-angular resolution experiment already exist. In this case, **explicitly mentioning how** you will make use of such complementary data in the proposal is a plus. Just mentioning you will use those data but without saying how usually does not help. If you have also checked the data archive of the observatories (e.g., ALMA, JVLA, Herschel, Spitzer, etc) and found some useful complementary data, you can also mention how you will make use of them in a joint analysis.
{: .fs-2 }

#### Preparation-2: Scientific justification and technical details

To complete the proposal submission, you need a **title**, an **Abstract**, a PDF scientific justifications with **2 pages of text and 2 pages of Figures/Tables**. If you are not sure about how to compose the Abstract or the 2+2 pages scientific justification, check [here](https://baobabyoo.github.io/pages/students_topics/proposal_obs.html).
{: .fs-2 }

Usually, we prepare the 2+2 pages justifications using LaTEX. If you are my student/postdoc, please use the [Overleaf](https://www.overleaf.com/) interface and share the link with me, *if you need my revision*. Use **fontsize 12** as far as you can. *Never make fontsize smaller than 11.* Do not use a very small margin. Try not to make your proposal over texty. No reviewer wants to spend more than **5 minutes** reading your proposal. Do not make it necessary for them to do so.
{: .fs-2 }

You will need to include your **observing time requests** through the online interface at the [SMA Observer Center](http://sma1.sma.hawaii.edu/). The observation for **each target source** at **each array configuration** with **each receiver tuning** need an independent observing time request that states how many hours you need for that target source at that setup. Based on the record(s) of your observing time request, the reviewers will check whether or not you are duplicating historical or ongoing projects unnecessarily.
{: .fs-2 }

******************************************************************************

You can check your **spectral setup (i.e., receiver tuning)** at [this page](http://sma1.sma.hawaii.edu/smaPassbandViewer/smaPassbandVis2020A.html). Usually, SMA does not re-tune the receiver for a PI in a night (e.g., it will not consider a project that requests to make short observations on one single target with >2 different receiver tunings; using two different tunings in one project in a night is already very rare since that costs a lot of overhead time in the (re-)tuning and in the passband calibration). If you are not sure about what tuning is feasible or not feasible, come discuss with me.
{: .fs-2 }

You can check the **angular resolution** and **sensitivity** *at your observing frequency* at [this page](http://sma1.sma.hawaii.edu/beamcalc.html).
{: .fs-2 }

Use [this page](http://sma1.sma.hawaii.edu/callist/callist.html) to check which **gain and passband calibrators** are ideal for your project. Usually, I try to pick a >0.7 Jy quasar as gain calibrator. It is the best if the angular separation between this quasar and your target source is less than 10 degrees. When the separation is in the range of 10~20 degrees, the phase errors can be noticible. A quasar that is >20 degrees separated from your target source should not be considered as you gain calibrator unless you are sure that your target source can be self-calibrated. Passband calibrator can be 3C84 or 3C279; bllac may be OK if you are not observing CO J=2-1 or CO J=3-2.
{: .fs-2 }

You can use [this page](http://sma1.sma.hawaii.edu/planetvis.html) to check which Solar System object can be your **absolute flux calibrator**. But don't worry too much about this. The SMA scheduler always double-checks which is the best one on the date of your observations.
{: .fs-2 }

******************************************************************************

#### Preparation-3: Scopes (being sufficiently ambitious)

A regular SMA proposal can request up to 100 hours of observing time. If you need 100~1000 hours, there is a Large Project category which is relatively hard. If you want to submit a Large Project proposal, prepare early. If you are student or postdoc in Taiwan, I would consider that it is fair to request **2~4 nights** of observing time in each proposal. If you are a Master's student and if your thesis is going to base on this SMA proposal, I would encourage you to think big and consider a project with **5~10 nights** of overall observing time. A night corresponds to 8~10 hours.
{: .fs-2 }

**Pick a problem that can be solved by such an investment resource.** You can think bigger once you have enough reputation to convince the reviewers that you can manage a larger-scale project.
{: .fs-2 }

### Organizing observing scripts

Here is a step-by-step guide:
{: .fs-2 }

Check the previous section if you are not sure how to pick calibrators (the relevant parts are in between the two horizontal gray lines); check [this page](https://baobabyoo.github.io/pages/students_topics/AstroBasic_RadioInterferometer.html) if you are confused about any thing (or everything).
{: .fs-1 }

1. Log in to the [SMA Observer Center](http://sma1.sma.hawaii.edu/).
2. Click the **My Projects** tab on the left.
3. From the list of your project, click into the relevant one. You will see the allocated observing tracks in the **Summary of tracks** section in the bottom. If there is not yet an observing script, there will be red text saying *(needs script)*.
4. Click **Track overview & script** next to the *(needs script)* text.
5. Scroll down to the **Observing Script** section. If you have never prepared an SMA script, then click **create new script using script generator**. If you are experienced, or if you are modifying a previously created script, you can click **manage script directly** will allows you to edit the ASCII script file.
6. The online **script generator** has self-contained explanation. You can follow through what it asks you to fill.
7. After a preliminary script is prepared using the script generator, and after you save the script, the online interface will allow you to enter the prospective UTC time of this observation and then **simulate** how the script works. After the start of a semester, a rough array configuration schedule will be provided [here](http://sma1.sma.hawaii.edu/array_config_sched.html). From there you can check in which month your project may be executed, and then use the simulator to see if all the calibrators can be observed above the elevation limit, and if the cycle time(s) of the target source loop(s) is indeed what you expect. You should definitely run this simulator and make sure there is no error message (e.g., any syntax error in your script that cause failure, or if your target source or calibrator goes above/below the elevation limit [85 degrees for target source and gaincal; 81 degrees for absolute flux calibrator; 87 degrees for passband calibrator]).
8. Sometimes you may need to control the LST start/end time of your target source loops (e.g., when you have multiple groups of target sources that need different gain calibrator, or when you want to control the duration of each target source loop). You can then click **manage script directly** can use the command like the following example:
{: .fs-2 }

```
print "----- main science target observe loop (vytau, xztau) -----\n";
$LST_start=20; $LST_end=2;
  &ObsLoop(cal1,targ3,targ4);

print "----- main science target observe loop (v1143ori, v1183ori, nyori)-----\n";
$LST_start=1.5; $LST_end=12;
  &ObsLoop(cal0,targ1,targ2,targ3);
```
{: .fs-1 }

The `print` commands does not do anything to the telescopes; it just prints some text to let the operator see what the array is going to do. Do simulate the script after making such edits in case of any surprise.
{: .fs-2 }

If you are a experienced user who are preparing scripts for the SMA polarization observations, scroll down to a template in the bottom of this page.
{: .fs-2 }

### Operation

A SMA operator will execute your observing script and will watch over the observations. So usually, there is nothing you need to do. But if you would like to participate in the operation or would like to monitor the operation, let me know.
{: .fs-2 }

### Data calibration and imaging

#### Software

You will need some software. An overview of them is provided [here](https://lweb.cfa.harvard.edu/rtdc/SMAdata/process/overview/).
{: .fs-2 }

The official software package to calibrated the SMA data is [MIR IDL](https://lweb.cfa.harvard.edu/~cqi/mircook.html). You can find examples of MIR IDL calibration procedures in that MIR IDL webpage (or click [here](https://lweb.cfa.harvard.edu/~cqi/mir/mirscript_2016jan22.txt) for the 2016 version and [here](https://lweb.cfa.harvard.edu/~cqi/mir/mir2018.txt) for the 2018 version). To use MIR IDL, you will need to install [IDL](https://www.l3harrisgeospatial.com/Software-Technology/IDL). It is not free (it is ultra expensive). If you do not have an access to an IDL license, come ask me.
{: .fs-2 }

Note that MIR IDL will load all raw data in a file to the memory of your computer. The loaded data will in fact occupy twice the raw data filesize in the memory due to using double precision variables (e.g., if the raw filesize is 100 GB, then it will occupy 200 GB in your memory). If the raw filesize is too large for your computer, you can use the [SMA Data Rechunker code](https://lweb.cfa.harvard.edu/rtdc/SMAdata/process/rechunk/) to bin the spectral channels to reduce the filesize, before loading into MIR IDL.
{: .fs-2 }

You can also use the [CASA software package](https://lweb.cfa.harvard.edu/rtdc/SMAdata/process/casa/) to calibrate the SMA data, which is less subject to memory issue (by design, CASA can handle large raw data with a computer with relatively small memory, although it can be very slow if the memory is way too small). By the time of early 2022, the CASA data reduction path remained somewhat experimental.
{: .fs-2 }

I usually use the [Miriad](https://lweb.cfa.harvard.edu/rtdc/SMAdata/process/miriad/) software package to image the SMA data. You can also use it to calibrate the SMA data. You can also use CASA to image your SMA data although it is a lot slower than Miriad.
{: .fs-2 }

#### Overview

No matter which sofware we use steps we are going through the following steps:
{: .fs-2 }

1. Load raw SMA data to MIR IDL format (and store it if you like).
2. Inspect data and flag (bad) the problematic data. You can then omit using the *flagged data* by unselecting them.
3. Convert the raw visibility amplitudes to physically meaningful units (e.g., Jy) and undone the atmospheric attenuation exp(-tau<sub>atm</sub>). This step is called **T<sub>sys</sub> application**.
4. Perform **passband calibration**.
5. Derive the absolute flux level of the gain calibrator by referencing to an absolute flux calibrator (e.g., usually a planet, planet moon, or the young star MWC349a). We call this step the **absolute flux calibration**.
6. Perform **complex gain calibration**.
7. Export data to Miriad or FITS format.
{: .fs-2 }


You may have some confusion about T<sub>sys</sub> application since:
{: .fs-2 }

- In some textbook, T<sub>sys</sub> is defined as (T<sub>rx</sub> + n<sub>eff</sub>T<sub>sky</sub> + (1- n<sub>eff</sub>)T<sub>ambient</sub>)/n<sub>eff</sub>, where n<sub>eff</sub> if the forward efficiency of the telescope, T<sub>rx</sub>, T<sub>sky</sub>, and T<sub>ambient</sub> are the receiver temperature, sky temperature, and the ambient temperature, respectively. SMA and ALMA defines T<sub>sys</sub> as (T<sub>rx</sub> + n<sub>eff</sub>T<sub>sky</sub> + (1- n<sub>eff</sub>)T<sub>ambient</sub>) / ( exp(-tau<sub>atm</sub>) n<sub>eff</sub> ).
- Some observatories already converted the raw data to physically meaningful units, while the raw SMA visibilities represent the *fraction* of correlated signal.
{: .fs-2 }

The T<sub>sys</sub> application step multiplies the raw SMA visibility with the T<sub>sys</sub> values to undone the atmospheric attenuation and to rescale the visibility  to Jansky (or Kelvin) units.
{: .fs-2 }

#### MIR Data calibration (no polarization)

##### Environment

I assume you are in an x86_64 Linux (e.g., CentOS, Ubuntu, Rocky, Redhat, etc) environment. If you have installed MIR IDL, or if somebody has installed it (e.g., if you are using a workstation at ASIAA), you need to *source* the setup file to enable using it. For example, I have my own installation, then type (revise to your own path):
{: .fs-2 }

```
(base) [hyliu@hyliu ~]$ source /home/hyliu/softwares/astro_reduction/MIR/sma-mir/setup.bsh
```
{: .fs-1 }

If you do not want to type this every time you launch a new terminal, you can include the following alias in your .bashrc file:
{: .fs-2 }

```
alias getmir="source /home/hyliu/softwares/astro_reduction/MIR/sma-mir/setup.bsh"
```
{: .fs-1 }

Then you can source MIR IDL and launch by typing:
{: .fs-2 }

```
(base) [hyliu@hyliu ~]$ getmir
(base) [hyliu@hyliu ~]$ idl
IDL 8.7.3 (linux x86_64 m64).
(c) 2020, Harris Geospatial Solutions, Inc.

Licensed for use by: Academia Sinica
License: 60400
% Compiled module: PRO_MIR_INIT.
% Compiled module: PRO_SETUP_ENV.
% Compiled module: PRO_CONSTANTS.
idl_startup completed
```
{: .fs-1 }

Type the following command to allow using color instead of black/white only.
{: .fs-2 }

```
IDL> device, decomposed=0, retain=2
```
{: .fs-1 }

##### Full procedure

I am taking the calibration of Chia-Ying's project SMA 2021B-A011 (one receiver and one sideband) as an example. I have binned every 16 spectral channels using the `SMARechunker` code at a workstation of SMA in Hawaii:
{: .fs-2 }

```
# under linux command line
/application/bin/SMARechunker -i /data/science/mir_data/220524_05:57:34 -o ./sma_2021Ba011_track1 -r 16
```
{: .fs-1 }

Until the data become archival, please contact us if you need the raw data for an exercise. The following is a full MIR IDL procedure. Each line is a command for an IDL command line (i.e., you copy and paste the command to the command line). Lines starting with a `#` symbol are comment lines. **If you are my student, you are required to preserve your calibration commands in such a format in case any of us (me, your co-Is, or the reviewers of your paper, etc) need to check certain details. Do Bookkeep everything strange or suspecious in the Notes sections.**
{: .fs-2 }

```
##### Read Data in MIR IDL ###############################################

# load raw data
readdata, dir='sma_2021Ba011_track1'

# check what is in the Data
select

# Inspect the spectra to find a suitable range of spectral channels
# to generate continuum data (used in most steps of calibrations)
# Here we select the passband calibrator 3C279 and the upper sidebands
select, /p, /reset, source=['3c279'], sideband='u'
# Here we select the RX345 receiver. "wt" gt "0" means unflagged (i.e., healthy) data.
result=dat_filter(s_f,' "rec" eq "345" and  "wt" gt "0" ')
plot_spectra, color_var ='band'

# re-generate continuum data by performing spectral averaging
# over the 6 spectral windows
select, /p, /reset, band=['c1','s1','s2','s3','s4','s5','s6']
uti_avgband, swmch1=60, swmch2=964
plot_continuum

# Examining the calibrator data
select, /p, /reset, source=['1517-243']
plot_continuum, x='int'

# flag phase jump
select, /p, /reset
result=dat_filter(s_f, '"blcd" like "2" or "blcd" like "5" ')
result=dat_filter(s_f, '"int" gt "256" and "int" lt "311"')
flag,/flag

select, /p, /reset
result=dat_filter(s_f, '"blcd" like "4" or "blcd" like "6" ')
result=dat_filter(s_f, '"int" gt "504" and "int" lt "559"')
flag,/flag

# Check and remove spectral spikes
select, /p, /reset
uti_checkspike, source='3c279', /baseline, threshold=5, /fix, sample=1

select, /p, /reset
uti_checkspike, source='bllac', /baseline, threshold=5, /fix, sample=1

select, /p, /reset
uti_checkspike, source='1517-243', /baseline, threshold=5, /fix, sample=1

# inspect spectra
select, /p, /reset, sideband='u', source=['3c279']
result=dat_filter(s_f,' "rec" eq "345" and  "wt" gt "0" ')
plot_spectra, x_var='channel', y_vars='amp,pha', frame_vars='blcd', color_vars='band', frames_per_page=4

select, /p, /reset, sideband='u', band='s3', source=['3c279']
result=dat_filter(s_f,' "rec" eq "345" and  "wt" gt "0" ')
plot_spectra, x_var='channel', y_vars='amp,pha', frame_vars='blcd', color_vars='band', frames_per_page=4

select, /p, /reset, band='s3'
uti_chanfix, chan=284

# regenerate continuum
select, /p, /reset, band=['c1','s1','s2','s3','s4','s5','s6']
uti_avgband, swmch1=60, swmch2=964
plot_continuum, x='int'
# check the data was flagged correctly

# examing the calibrator data again
select, /p, /reset, source=['1517-243']
plot_continuum, x='int'

# save MIR format data
select, /p, /reset
mir_save, 'ChiaYing_track1.mir', /new

### Notes ################################################################
#
# Calibrating the RX345 USB
#
# passband: 3c279
# source  :
# Flux    : Callisto
# gain    : 1517-243
#
# (tau_225 GHz: 0.05~0.06) after 07:30 UTC
#
##########################################################################



##### Inspect elevation ################################

result = plo_var('dhrs','el',frames_per_page=1)

##### Notes ############################################
#
# Elevation of Neptune in between 25 and 35 deg.
#
########################################################



##### Initial Data Insepction ############################################

select, /p, /reset, source=['1517-243','HBC_266'], sideband='u'
result=dat_filter(s_f,' "rec" eq "345" and  "wt" gt "0" ')
plot_continuum, x = 'int'


##### Flag the ipoint Data and Strange data ##############################

select, /p, /reset, sideband='u'
result=dat_filter(s_f,' "rec" eq "345" and  "wt" gt "0" ')
result=dat_filter(s_f, '"int" gt "1576" and "int" lt "1682" ')
flag,/flag

# check the continuum again
select, /p, /reset
plot_continuum, x = 'int'

select, /p, /reset
mir_save, 'ChiaYing_track1.flag.mir'

##### Notes ##############################################################
#
# You may need to iterate through data inspection and flagging a few times.
#
##########################################################################



#### Tsys Application  ###################################################

# inspect Tsys
select,/p,/reset
result=dat_filter(s_f,' "rec" eq "345" and  "wt" gt "0" ')
plot_var, frames_p=6

select,/p,/reset
apply_tsys
plot_continuum, x='int'

select, /p, /reset, source=['3c279','1517-243','bllac'], sideband='u'
result=dat_filter(s_f,' "rec" eq "345" and  "wt" gt "0" ')
plot_continuum, x = 'int'

select,/p,/reset
mir_save, 'ChiaYing_track1.tsys.mir'

## Notes #################################################################
#
# Except for ant 8
#    345 GHz: Tsys is 700-1300 K in the target loop
# baseline with ant 8 has 800-1700 K Tsys
#
#########################################################################



#### Passband Calibration ################################################

select, /p, /reset
result=dat_filter(s_f, ' "wt" gt "0" and "nch" eq "1024" ', /reset)
pass_cal, cal_type='pha', smoothing=16, ntrim=64, frames_p=16,refant=1
# all no
# 3c279 yes

select, /p, /reset, band=['c1','s1','s2','s3','s4','s5']
uti_avgband, swmch1=60, swmch2=964

# re-inspect passband splikes
select, /p, /reset, sou='3c279', sideband='u'
result=dat_filter(s_f,' "rec" eq "345" and  "wt" gt "0" ')
plot_spectra, x_var='channel', y_vars='amp,pha', frame_vars='blcd', color_vars='band', frames_per_page=4

select, /p, /reset
result=dat_filter(s_f, ' "wt" gt "0" and "nch" eq "1024" ', /reset)
pass_cal, cal_type='amp', smoothing=16, ntrim=64, frames_p=16, refant=1

select, /p, /reset
mir_save, 'ChiaYing_track1.tsys.bp.mir'

## Notes #################################################################

# http://sma1.sma.hawaii.edu/planetvis.html
# Callisto: 12.1  Jy @ 357 GHz
May 24

# http://sma1.sma.hawaii.edu/callist/callist.html
# J1517-243
 850   04 Apr 2014 12:59   SMA       350.06   0.979 +/-  0.050    mgurwell  
 850   15 Apr 2014 12:31   SMA       356.05   1.059 +/-  0.072    mgurwell  
 850   27 Mar 2021 14:40   SMA       346.97   1.099 +/-  0.061    mgurwell  

# 3c279
 850   08 Jun 2021 03:08   SMA       350.24   8.820 +/-  0.562    mgurwell  
 850   13 Aug 2021 04:10   SMA       346.28   8.930 +/-  0.447    mgurwell  
 850   23 Nov 2021 15:36   SMA       340.98   9.151 +/-  0.458    mgurwell  

# bllac
 850   08 Jul 2021 17:02   SMA       346.02   3.631 +/-  0.190    mgurwell  
 850   13 Aug 2021 11:29   SMA       346.28   6.363 +/-  0.318    mgurwell  
 850   23 Nov 2021 04:16   SMA       340.98   5.554 +/-  0.278    mgurwell  

##########################################################################



#### Measure the Absolute Flux ###########################################

select, /p, /reset, band='c1', sideband='u'
result=dat_filter(s_f,' "rec" eq "345" and  "wt" gt "0" ')
gain_cal, cal_type='pha', x='hours', /connect, /non_point, tel_bsl='telescope', refant=2
# all no
# 1517-243 yes 1
# bllac yes 1
# 3c279 yes 1
# Callisto yes 1

select,/p,/re,int=[0,50]
flag,/flag

select, /p, /reset, band='c1', sideband='u'
result=dat_filter(s_f,' "rec" eq "345" and  "wt" gt "0" ')
gain_cal, cal_type='amp', x='hours', poly=0, tel_bsl='telescope', refant=6, /preavg, /non_point
# all no
# Callisto yes 12.1

select, /p, /reset, band='c1', sideband='u', source=['3c279','bllac','1517-243','Callisto']
result=dat_filter(s_f, ' "el" gt "25" and "el" lt "40"' )
result=dat_filter(s_f,' "rec" eq "345" and  "wt" gt "0" ')
flux_measure

# Scalar average:
#   Source   Flags   Nscans  Flux(Jy)   SNR    meantime    REAL       IMAG
#   1517-243            105    1.1226     227      9.83      1.1132     -0.0016
#   Callisto      g      40    5.3998      43     14.59      5.0955     -0.0109

# Vector average:
#   Source   Flags   Nscans  Flux(Jy)   SNR    meantime    REAL       IMAG
#   1517-243            105    1.1132     223      9.83      1.1132     -0.0016
#   Callisto      g      40    5.0955      35     14.59      5.0955     -0.0109


select, /p, /reset, band='c1', sideband='u', source=['3c279','bllac','1517-243','Callisto']
result=dat_filter(s_f,' "rec" eq "345" and  "wt" gt "0" ')
flux_measure

Scalar average:
#   Source   Flags   Nscans  Flux(Jy)   SNR    meantime    REAL       IMAG
#     3c279            160    8.3092    1252      6.46      8.3083      0.0029
#  1517-243            221    1.1515     343      9.82      1.1420     -0.0015
#     bllac            264    6.0733    1323     14.06      6.0719     -0.0020
#  Callisto      g      40    5.3998      43     14.59      5.0955     -0.0109

# Vector average:
#   Source   Flags   Nscans  Flux(Jy)   SNR    meantime    REAL       IMAG
#     3c279            160    8.3083    1251      6.46      8.3083      0.0029
#  1517-243            221    1.1420     336      9.82      1.1420     -0.0015
#     bllac            264    6.0719    1322     14.06      6.0719     -0.0020
#  Callisto      g      40    5.0955      35     14.59      5.0955     -0.0109

## Notes #################################################################

# apply :
# RX 345
#   USB
#   1517-243 yes 1.1132

##########################################################################



#### Gain Calibration and Miriad Files Output ############################

mir_restore, 'ChiaYing_track1.tsys.bp.mir'

select, /p, /reset, source=['1517-243', 'DoAr_33'], sideband='u'
result=dat_filter(s_f,' "rec" eq "345" and  "wt" gt "0" ')
plot_continuum, x = 'int'

select, /p, /reset, sideband='u'
result=dat_filter(s_f, '"blcd" like "2"')
result=dat_filter(s_f,' "rec" eq "345" and  "wt" gt "0" ')
result=dat_filter(s_f, '"int" gt "567" and "int" lt "618" ')
flag,/flag

select, /p, /reset, sideband='u'
result=dat_filter(s_f,' "rec" eq "345" and  "wt" gt "0" ')
gain_cal, x='hours', cal_type='pha', tel_bsl='telescope', refant=6, /connect, /preavg, /non_point
# apply :
  all no
#   1517-243 yes 1.1132

gain_cal, x='hours',cal_type='amp',tel_bsl='telescope',refant=6,  smoothing=1, /preavg, /non_point

# check gain calibrator again
select, /p, /reset, sideband='u', source=['DoAr_44','1517-243']
result=dat_filter(s_f,' "rec" eq "345" and  "wt" gt "0" ')
plot_continuum, x='int'

select,/p,/reset
result=dat_filter(s_f,' "rec" eq "345" and  "wt" gt "0" ')
mir_save, 'ChiaYing_track1.rx345.usb.cal.mir', /new

select, /p, /reset, sideband='u'
result=dat_filter(s_f, '"blcd" like "4" and "blcd" like "8"')
result=dat_filter(s_f,' "rec" eq "345" and  "wt" gt "0" ')
result=dat_filter(s_f, '"int" gt "1513" and "int" lt "1700" ')
flag,/flag

idl2miriad, dir='DoAr_16_track1.rx345.usb.cal.miriad',sideband='u',source='DoAr_16',band=['s1','s2','s3','s4']

```
{: .fs-1 }


Sometimes I also check the ALMA Calibrator Grid Survey and see if we can get consistent absolute flux measurement:
{: .fs-2 }

```
# In CASA 5 command line
import sys
sys.path.append("./analysis_scripts")
import analysisUtils as au

# 1517-243
CASA <27>: au.getALMAFlux('J1517-243', '357GHz', lowband=3, highband=7, date='20220524')
  Closest Band 3 measurement: 1.850 +- 0.030 (age=+5 days) 103.5 GHz (will extrapolate from this datum using spectral index)
  Closest Band 3 measurement: 1.890 +- 0.030 (age=+5 days) 91.5 GHz (will extrapolate from this datum using spectral index)
  Closest Band 7 measurement: 1.117 +- 0.100 (age=+1 days) 362.7 GHz
  Closest Band 7 measurement: 1.100 +- 0.114 (age=+1 days) 362.7 GHz
getALMAFluxCSV(Cycle6): Fitting for spectral index with 1 measurement pair of age -4.0 days from 20220524, with age separation of 2 days
  20220529 -- 20220531: freqs=[91.47, 350.5], fluxes=[1.86, 1.236]
Median Monte-Carlo result for 357.000000 = 1.231747 +- 0.149251 (scaled MAD = 0.147478)
Result using spectral index of -0.304237 for 357.000 GHz from 1.870 Jy at 97.485 GHz = 1.259895 +- 0.149251 Jy

# 3c279
CASA <28>: au.getALMAFlux('J1256-057', '357GHz', lowband=3, highband=7, date='20220524')
  Closest Band 3 measurement: 16.970 +- 0.150 (age=+2 days) 103.5 GHz (will extrapolate from this datum using spectral index)
  Closest Band 3 measurement: 16.667 +- 0.537 (age=+2 days) 92.9 GHz (will extrapolate from this datum using spectral index)
  Closest Band 3 measurement: 17.820 +- 0.220 (age=+2 days) 91.5 GHz (will extrapolate from this datum using spectral index)
  Closest Band 7 measurement: 8.759 +- 0.453 (age=+1 days) 341.5 GHz
getALMAFluxCSV(Cycle6): Fitting for spectral index with 1 measurement pair of age 1.5 days from 20220524, with age separation of 1 days
  20220522 -- 20220523: freqs=[103.5, 92.9, 91.47, 341.5], fluxes=[16.97, 16.667, 17.82, 8.759]
Median Monte-Carlo result for 357.000000 = 8.771665 +- 1.036714 (scaled MAD = 1.012588)
Result using spectral index of -0.523435 for 357.000 GHz from 17.152 Jy at 95.957 GHz = 8.622924 +- 1.036714 Jy

# bllac
CASA <7>: au.getALMAFlux('J2202+422', '357GHz', lowband=3, highband=7, date='20220524')
  Closest Band 3 measurement: 8.910 +- 0.450 (age=+3858 days) 109.8 GHz (will extrapolate from this datum using spectral index)
  Closest Band 3 measurement: 8.960 +- 0.450 (age=+3858 days) 97.7 GHz (will extrapolate from this datum using spectral index)
  Closest Band 7 measurement: 1.109 +- 0.055 (age=+1384 days) 343.5 GHz
getALMAFluxCSV(Cycle6): Fitting for spectral index with 1 measurement pair of age 3223.5 days from 20220524, with age separation of 1269 days
  20111031 -- 20150422: freqs=[109.8, 97.7, 334.92], fluxes=[8.91, 8.96, 3.2]
Median Monte-Carlo result for 357.000000 = 3.040985 +- 0.402249 (scaled MAD = 0.393821)
Result using spectral index of -0.867940 for 357.000 GHz from 8.935 Jy at 103.750 GHz = 3.056952 +- 0.402249 Jy
WARNING: the mean time separation between the target date and the flux monitoring observations is 3858 days

```
{: .fs-1 }

#### Miriad imaging

If you have installed Miriad, you can source it with a Linux command (can also make an alias for this):
{: .fs-2 }

```
source /home/hyliu/softwares/Miriad/carma/miriad/miriad_start.sh
```
{: .fs-1 }

For an online documentation for the individual Miriad tasks, please check the [Miriad task list](https://www.atnf.csiro.au/computing/software/miriad/taskindex.html).
{: .fs-2 }

##### Flagging edge channels and continuum subtraction

We are using the Miriad software package here, either under linux command line or using a BASH script.
{: .fs-2 }

Sometimes the edge channels of a spectral window can have poor response. You can inspect the spectral data using the Miriad command like:
{: .fs-2 }

```
# uvspec vis=IP_Tau_track5.rx400.lsb.cal.miriad axes=freq,amp nxy=1,1 device=/xw options=nobase,avall interval=999999 select='window(1,2,3)'
```
{: .fs-2 }

You can flag them using a BASH script like:
{: .fs-2 }

```
#!/bin/bash

config="com"
flagval="f"

targets='BP_Tau'
sidebands='usb'
ifbands='rx400'

for field in $targets
do
  for sideband in $sidebands
  do

    for ifband in $ifbands
    do

       uvflag vis=$field'_track5.'$ifband'.'$sideband'.cal.miriad' edge=64,64,0 flagval=$flagval

    done

  done
done
```
{: .fs-1 }


After inspecting spectral lines in the data, you can perform continuum baseline fitting and subtraction using a BASH script like:
{: .fs-2 }

```
#!/bin/bash


config="com"
flagval="f"

targets='ChiaYing_track5'
sidebands='usb lsb'
ifbands='rx400'

for field in $targets
do

    chans='0,6143'
    # outputing continuum data
    uvlin vis=$field'.rx400.lsb.cal.miriad' out=$field'.'$config'.rx400.lsb.ch0.miriad' \
          chans=$chans mode=chan0 options=nocal,nopass,nopol,nowin order=1
    # outputing continuum subtracted line data
    uvlin vis=$field'.rx400.lsb.cal.miriad' out=$field'.'$config'.rx400.lsb.line.miriad' \
          chans=$chans mode=line options=nocal,nopass,nopol,nowin order=1


done
```
{: .fs-1 }

##### Single pointing, continuum imaging

You can perform continuum imaging using a BASH script like the following one:
{: .fs-2 }

```
#!/bin/bash
# Miriad task list
# https://www.atnf.csiro.au/computing/software/miriad/taskindex.html

field="BP_Tau"


# creat dirty image (i.e., inverse Fourier transform)
rm -rf $field'.dirty'
rm -rf $field'.beam'
invert vis=$field'_track5.rx400.usb.cal.miriad' options=systemp,mfs,double map robust=2.0 map=$field'.dirty' beam=$field'.beam' cell=0.25 imsize=256

rm -rf $field'.dirty.fits'
rm -rf $field'.beam.fits'
fits in=$field'.dirty' op=xyout out=$field'.dirty.fits'
fits in=$field'.beam' op=xyout out=$field'.beam.fits'


# deconvolve image
rm -rf $field'.model'
rm -rf $field'.model.fits'
clean map=$field'.dirty' beam=$field'.beam' out=$field'.model' cutoff=0.015 niters=100
fits in=$field'.model' op=xyout out=$field'.model.fits'


# restore image (i.e., convolve the clean components with a clean Gaussian beam)
rm -rf $field'.clean'
rm -rf $field'.clean.fits'
restor map=$field'.dirty' beam=$field'.beam' model=$field'.model' mode=clean out=$field'.clean'
fits in=$field'.clean' op=xyout out=$field'.clean.fits'

# generate residual image
rm -rf $field'.residual'
rm -rf $field'.residual.fits'
restor map=$field'.dirty' beam=$field'.beam' model=$field'.model' mode=residual out=$field'.residual'
fits in=$field'.residual' op=xyout out=$field'.residual.fits'


# Perform primary beam correction
rm -rf $field'.clean.pbcor'
rm -rf $field'.clean.pbcor.fits'
linmos in=$field'.clean' out=$field'.clean.pbcor'
fits in=$field'.clean.pbcor' op=xyout out=$field'.clean.pbcor.fits'
```
{: .fs-1 }

##### Single pointing, spectral lines imaging

##### Mosaic imaging

##### Combining single dish and interferometric observations

For a Miriad based procedure, please check my documentation under the [ALMICA](https://github.com/baobabyoo/almica) repository.
{: .fs-2 }

#### Miriad self-calibration

#### CASA Data calibration and imaging (under construction)


#### MIR Data calibration (polarization)

Here I provide the example MIR IDL + Miriad scripts of calibrating the *dual RX full polarization data taken after 2017 August* and *single RX polarization data taken before 2016*. The polarization data taken in between may be subject to some hardware or software issues. If you really need to use them, it is recommended to contact Dr. Ramprasad Rao.
{: .fs-2 }

##### Dual RX Data taken after 2017 August (under construction)

##### Single RX Data taken before 2016 (under construction)


### Publishing

You are required to include the following statement in the Acknowledgement:
{: .fs-2 }

*
The Submillimeter Array is a joint project between the Smithsonian Astrophysical Observatory and the Academia Sinica Institute of Astronomy and Astrophysics, and is funded by the Smithsonian Institution and the Academia Sinica (Ho et al. 2004).
*
{: .fs-2 }

You are required to cite [Ho et al. (2004)](https://ui.adsabs.harvard.edu/abs/2004ApJ...616L...1H/abstract).
{: .fs-2 }

Your are required to cite [Sault et al. (1995)](https://ui.adsabs.harvard.edu/abs/1995ASPC...77..433S/abstract), [Qi et al. (2003)](https://ui.adsabs.harvard.edu/abs/2003cdsf.conf..393Q/abstract), or [McMullin et al. (2007)](https://ui.adsabs.harvard.edu/abs/2007ASPC..376..127M/abstract) if you use Miriad, MIR IDL, or CASA to process your data.
{: .fs-2 }

When you are carrying out a *precision experiment* instead of a *detection experiment* you may want/need to refer to the [SMA Calibrator List](http://sma1.sma.hawaii.edu/callist/callist.html). If you are quoting the records explicitly in your paper, you need to make an E-mail contact with Dr. Mark Gurwell and obtain his agreement. You need to inquire how he would like to be credited (e.g., as a co-author or being mentioned in the acknowledgement).
{: .fs-2 }

### When you get stuck

If you are located in Taiwan, you can either ask me or my present Master's student, [Chia-Ying Chung](http://www.asiaa.sinica.edu.tw/people/cv.php?i=cychung).
{: .fs-2 }

Note that she is not obligated to work for you or answer your questions regardless of your career stage. If you are making a very big request to her, for example, if you need her to teach you or walk you through data calibrations, or even calibrate data for you, then you should regard this as a formal collaboration and should include her as a co-I when you are making a journal publication. Please appreciate that it takes a very significant effort for her to pick up this skill. She still has the right to say no to you (so be nice to her). I also have the right to say no to you for her, to ensure that she can be sufficiently focused on her thesis project.
{: .fs-1 }


### Polarization observing script

Here is a template. You are likely experienced enough to understand the syntax. You should do the necessary modification. Please be sure to find all XXX using the "find" function of your browser and replace them with appropriate values.
{: .fs-2 }

You need to use the **manage script directly** method to edit in the polarization script. Please do simulate the script online.
{: .fs-2 }

```
#!/usr/bin/perl -w
{ BEGIN {$^W =0}
#
################## Script Header Info #####################
#
# Experiment Code: 2022A-AXXX
# Experiment XXX
# PI: XXX    
# Contact Person: XXX
# Email  : XXX
# Cell : XXX
# Array  : XXX
#
############## SPECIAL INSTRUCTIONS ################
#
# Please observe the polarization calibrator 3CXXX for XXX minutes
# before (or after) the target source loop.
#
# It would be best if we can observe the polarization calibrator
# for at least 40 minutes during its transit (or before and after
# the transit if the calibrator transits at too high elevation).
#
################## Priming ################################

# observe -s MyPetSource -r XX:XX:XX.XX -d -XX:XX:XX.X -e 2000 -v XX
# dopplerTrack -r XXX.XX -u -s1 -f 0.0000 -h 10 -R h -r XXX.XX -u -s1 -f 0.0000 -h 10
# POL_CAL: 3c279 or bllac (before target source loop)
#          or 3c84 (after target source loop; preferable)
#
################## Pointing ###############################
#
# Pointing: At start of track and after transit
# Syntax Example: point -i 60 -r 3 -L -l -t -Q
#
################## Source, Calibrator and Limits ##########
#
# set scan time
$inttime="15";
#
# choose which antennas with waveplates crossed during the cross RX calibration
# !!! Antennas chosen MUST BE IN THE ARRAY !!!
$pants='4,6';


# POL_CAL
$cal0="3c84"; $ncal0="12";
$calpol0="3C84_LR -r 03:19:48.1601 -d 41:30:42.103 -e 2000 -v 0"; $ncalpol0="12";

$cal1="3c279"; $ncal1="12";
$calpol1="3C279_LR";$ncalpol1="12";

$cal2="bllac"; $ncal2="12";
$calpol2="bllac_LR";$ncalpol2="12";


# Gain cal
$cal3="XXXX-XXX"; $ncal3="16";
$calpol3="XXXX-XXX_LR -r XX:XX:XX.XXXX -d -XX:XX:XX.XXX -e 2000 -v 0"; $ncalpol3="15";

$targ1="MyPetSource -r XX:XX:XX.XX -d -XX:XX:XX.X -e 2000 -v XXX"; $ntarg1="24";


# FluxCal
$flux0="Callisto"; $nflux0="20";

XXX Change all MINEL to 33 degree for the subcompact track
$MINEL_TARG = 20; $MAXEL_TARG = 85;
$MINEL_GAIN = 20; $MAXEL_GAIN = 85;
$MINEL_FLUX = 20; $MAXEL_FLUX = 81;
$MINEL_BPASS= 20; $MAXEL_BPASS= 87;
$MINEL_CHECK= 20;


#
################## Script Initialization ##################
#
do 'sma.pl';
do 'sma_add.pl';

checkANT();
command("radio");
command("integrate -t $inttime");
$myPID=$$;
command("project -r -p 'SMA' -d '2022A-AXXX'");
print "----- initialization done, starting script -----\n";
#
################## Science Script #########################


#
print "####################################################\n";
print "########### Polcal loop 3C279     ##\n";
print "####################################################\n";
$LST_start=XX.X; $LST_end=XX.X;
&DoPolPass(cal1,ncal1,calpol1,ncalpol1);

#
print "#############################################\n";
print "## Observing target source ##################\n";
print "## Gaincal: 1743-038    ########################\n";
print "## Cross hand phase: 1743-038_LR ########\n";
print "## End the loop with 1743-038 ###############\n";
print "#############################################\n";
$LST_start=XX.X; $LST_end=XX.X;
&DualPolLoop(calpol3,ncalpol3,cal3,ncal3,targ1,ntarg1);

#
print "####################################################\n";
print "######### flux Calibration loop on fluxcal ##########\n";
print "####################################################\n";
$LST_start=XX.X; $LST_end=XX.X;
$max_loops=3;
&DoPolFlux(flux0,nflux0);


#
print "####################################################\n";
print "########### Polcal loop 3C84     ##\n";
print "####################################################\n";
$maxloops="200";
$LST_start=XX.X; $LST_end=XX.X;
&DoPolPass(cal0,ncal0,calpol0,ncalpol0);


#
print "----- Congratulations!  This is the end of the script.  -----\n";}
#
################## File End ###############################
```
{: .fs-1 }
